name: CD Pipeline (Multi-Tenant)

on:
  push:
    branches:
      - 'community/**'

jobs:
  # ==================== DETECT & VALIDATE COMMUNITY ====================
  setup:
    name: Setup Community Deployment
    runs-on: ubuntu-latest
    outputs:
      community: ${{ steps.extract.outputs.community }}
      community-upper: ${{ steps.extract.outputs.community-upper }}
      community-normalized: ${{ steps.extract.outputs.community-normalized }}
      should-deploy: ${{ steps.validate.outputs.should-deploy }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Extract community name
        id: extract
        run: |
          BRANCH="${{ github.ref }}"
          COMMUNITY=$(echo "$BRANCH" | sed 's/refs\/heads\/community\///')

          # ÐÐ¾Ñ€Ð¼Ð°Ð»Ñ–Ð·ÑƒÑ”Ð¼Ð¾ Ð½Ð°Ð·Ð²Ñƒ (lowercase, Ð±ÐµÐ· ÑÐ¿ÐµÑ†ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ–Ð²)
          COMMUNITY_NORMALIZED=$(echo "$COMMUNITY" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')

          # Uppercase Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ñ–Ð²
          COMMUNITY_UPPER=$(echo "$COMMUNITY" | tr '[:lower:]' '[:upper:]' | tr '-' '_')

          echo "community=$COMMUNITY" >> $GITHUB_OUTPUT
          echo "community-upper=$COMMUNITY_UPPER" >> $GITHUB_OUTPUT
          echo "community-normalized=$COMMUNITY_NORMALIZED" >> $GITHUB_OUTPUT

          echo "ðŸ“ Community: $COMMUNITY"
          echo "ðŸ“ Normalized: $COMMUNITY_NORMALIZED"
          echo "ðŸ“ Upper: $COMMUNITY_UPPER"

      - name: âœ… Validate community configuration
        id: validate
        env:
          COMMUNITY_UPPER: ${{ steps.extract.outputs.community-upper }}
        run: |
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ñ‡Ð¸ Ñ” Ð²ÑÑ– Ð½ÐµÐ¾Ð±Ñ…Ñ–Ð´Ð½Ñ– ÑÐµÐºÑ€ÐµÑ‚Ð¸ Ð´Ð»Ñ Ñ†Ñ–Ñ”Ñ— Ð³Ñ€Ð¾Ð¼Ð°Ð´Ð¸
          # GitHub Actions Ð½Ðµ Ð´Ð¾Ð·Ð²Ð¾Ð»ÑÑ” Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ‚Ð¸ Ñ–ÑÐ½ÑƒÐ²Ð°Ð½Ð½Ñ ÑÐµÐºÑ€ÐµÑ‚Ñ–Ð² Ð½Ð°Ð¿Ñ€ÑÐ¼Ñƒ,
          # Ñ‚Ð¾Ð¼Ñƒ Ñ†Ðµ Ð±ÑƒÐ´Ðµ Ð·Ñ€Ð¾Ð±Ð»ÐµÐ½Ð¾ Ð² deploy job

          # Ð¢ÑƒÑ‚ Ð¼Ð¾Ð¶Ð½Ð° Ð´Ð¾Ð´Ð°Ñ‚Ð¸ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÑƒ Ð½Ð° Ñ–ÑÐ½ÑƒÐ²Ð°Ð½Ð½Ñ ÐºÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–Ð¹Ð½Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ñƒ
          if [ -f ".github/communities/${{ steps.extract.outputs.community-normalized }}.json" ]; then
            echo "âœ… Configuration file exists"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Configuration file not found, but proceeding"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

  # ==================== BUILD ====================
  build:
    name: Build for ${{ needs.setup.outputs.community }}
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should-deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Backend
      - name: ðŸ“¦ Install Backend Dependencies
        run: |
          cd back
          npm ci --production

      # Frontend - Ð±Ñ–Ð»Ð´ Ð· community-specific ÐºÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–Ñ”ÑŽ
      - name: ðŸ—ï¸ Build Frontend for ${{ needs.setup.outputs.community }}
        run: |
          cd front
          npm ci

          # ÐœÐ¾Ð¶Ð½Ð° Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ community-specific .env Ð°Ð±Ð¾ ÐºÐ¾Ð½Ñ„Ñ–Ð³ÑƒÑ€Ð°Ñ†Ñ–ÑŽ
          if [ -f "../.github/communities/${{ needs.setup.outputs.community-normalized }}.env" ]; then
            cp ../.github/communities/${{ needs.setup.outputs.community-normalized }}.env .env.production
          fi

          npm run build
        env:
          NODE_ENV: production
          VITE_COMMUNITY_NAME: ${{ needs.setup.outputs.community }}

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ needs.setup.outputs.community-normalized }}
          path: |
            back/
            front/dist/
          retention-days: 7

  # ==================== DEPLOY ====================
  deploy:
    name: Deploy to ${{ needs.setup.outputs.community }}
    runs-on: ubuntu-latest
    needs: [setup, build]
    if: needs.setup.outputs.should-deploy == 'true'
    # Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ dynamic environment
    environment:
      name: ${{ needs.setup.outputs.community }}
      url: ${{ secrets[format('{0}_APP_URL', needs.setup.outputs.community-upper)] }}

    steps:
      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package-${{ needs.setup.outputs.community-normalized }}

      - name: ðŸ“¤ Transfer Backend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[format('{0}_SSH_HOST', needs.setup.outputs.community-upper)] }}
          username: ${{ secrets[format('{0}_SSH_USER', needs.setup.outputs.community-upper)] }}
          key: ${{ secrets[format('{0}_SSH_PRIVATE_KEY', needs.setup.outputs.community-upper)] }}
          port: ${{ secrets[format('{0}_SSH_PORT', needs.setup.outputs.community-upper)] || 22 }}
          source: "back/*"
          target: "/home/bot/adminka/backend/"
          strip_components: 1
          rm: false

      - name: ðŸ“¤ Transfer Frontend Files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets[format('{0}_SSH_HOST', needs.setup.outputs.community-upper)] }}
          username: ${{ secrets[format('{0}_SSH_USER', needs.setup.outputs.community-upper)] }}
          key: ${{ secrets[format('{0}_SSH_PRIVATE_KEY', needs.setup.outputs.community-upper)] }}
          port: ${{ secrets[format('{0}_SSH_PORT', needs.setup.outputs.community-upper)] || 22 }}
          source: "front/dist/*"
          target: "/home/bot/adminka/frontend/"
          strip_components: 2
          rm: false

      - name: ðŸš€ Deploy to ${{ needs.setup.outputs.community }} Server
        uses: appleboy/ssh-action@v1.0.0
        env:
          COMMUNITY: ${{ needs.setup.outputs.community }}
        with:
          host: ${{ secrets[format('{0}_SSH_HOST', needs.setup.outputs.community-upper)] }}
          username: ${{ secrets[format('{0}_SSH_USER', needs.setup.outputs.community-upper)] }}
          key: ${{ secrets[format('{0}_SSH_PRIVATE_KEY', needs.setup.outputs.community-upper)] }}
          port: ${{ secrets[format('{0}_SSH_PORT', needs.setup.outputs.community-upper)] || 22 }}
          envs: COMMUNITY
          script: |
            BACKEND_DIR="/home/bot/adminka/backend"
            FRONTEND_DIR="/home/bot/adminka/frontend"

            echo "ðŸš€ Deploying $COMMUNITY"

            # Ð‘ÐµÐºÐ°Ð¿ Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¾Ñ— Ð²ÐµÑ€ÑÑ–Ñ— backend
            if [ -d "$BACKEND_DIR" ]; then
              echo "ðŸ“¦ Creating backup..."
              BACKUP_DIR="/home/bot/backups"
              mkdir -p "$BACKUP_DIR"
              tar -czf "$BACKUP_DIR/backend-backup-$(date +%Y%m%d-%H%M%S).tar.gz" -C "$BACKEND_DIR" .

              # Ð’Ð¸Ð´Ð°Ð»ÑÑ”Ð¼Ð¾ ÑÑ‚Ð°Ñ€Ñ– Ð±ÐµÐºÐ°Ð¿Ð¸ (Ð·Ð°Ð»Ð¸ÑˆÐ°Ñ”Ð¼Ð¾ 10 Ð¾ÑÑ‚Ð°Ð½Ð½Ñ–Ñ…)
              ls -t $BACKUP_DIR/backend-backup-*.tar.gz 2>/dev/null | tail -n +11 | xargs -r rm
            fi

            echo "ðŸ“ Deployment directories ready"

            # Ð’ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ Ð·Ð°Ð»ÐµÐ¶Ð½Ð¾ÑÑ‚Ñ–
            cd $BACKEND_DIR
            npm ci --production

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–Ñ— (ÑÐºÑ‰Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾)
            # npm run migrate

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ PM2
            echo "ðŸ”„ Restarting backend service..."
            pm2 restart adminka || pm2 start index.js --name adminka

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÑƒÑ”Ð¼Ð¾ Nginx Ð´Ð»Ñ frontend
            echo "ðŸ”„ Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || echo "âš ï¸ Nginx reload skipped"

            echo "âœ… Deployment completed for $COMMUNITY!"

      - name: ðŸ§ª Health Check
        env:
          COMMUNITY_UPPER: ${{ needs.setup.outputs.community-upper }}
        run: |
          # Ð”Ð¸Ð½Ð°Ð¼Ñ–Ñ‡Ð½Ð¾ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ”Ð¼Ð¾ URL Ð· ÑÐµÐºÑ€ÐµÑ‚Ñ–Ð²
          APP_URL="${{ secrets[format('{0}_APP_URL', needs.setup.outputs.community-upper)] }}"

          echo "ðŸ” Checking site availability: $APP_URL"

          for i in {1..5}; do
            # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ–ÑÑ‚ÑŒ Ð³Ð¾Ð»Ð¾Ð²Ð½Ð¾Ñ— ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÐ¸
            if curl -f -s -o /dev/null -w "%{http_code}" "$APP_URL" | grep -q "200\|301\|302"; then
              echo "âœ… Site is accessible for ${{ needs.setup.outputs.community }}"
              exit 0
            fi
            echo "â³ Waiting for server... ($i/5)"
            sleep 10
          done

          echo "âš ï¸ Health check failed (might need manual verification)"
          # ÐÐµ Ð¿Ð°Ð´Ð°Ñ”Ð¼Ð¾, ÑÐºÑ‰Ð¾ health check Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹
          exit 0

  # ==================== DATABASE MIGRATION ====================
  migrate:
    name: Run Migrations for ${{ needs.setup.outputs.community }}
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: needs.setup.outputs.should-deploy == 'true' && github.event.head_commit.message contains '[migrate]'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ—„ï¸ Run Database Migrations
        uses: appleboy/ssh-action@v1.0.0
        env:
          COMMUNITY: ${{ needs.setup.outputs.community }}
        with:
          host: ${{ secrets[format('{0}_SSH_HOST', needs.setup.outputs.community-upper)] }}
          username: ${{ secrets[format('{0}_SSH_USER', needs.setup.outputs.community-upper)] }}
          key: ${{ secrets[format('{0}_SSH_PRIVATE_KEY', needs.setup.outputs.community-upper)] }}
          port: ${{ secrets[format('{0}_SSH_PORT', needs.setup.outputs.community-upper)] || 22 }}
          envs: COMMUNITY
          script: |
            BACKEND_DIR="/home/bot/adminka/backend"
            cd $BACKEND_DIR

            echo "ðŸ—„ï¸ Running database migrations for $COMMUNITY"

            # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ Ð¼Ñ–Ð³Ñ€Ð°Ñ†Ñ–Ñ—
            npm run migrate || node migrations/migrate-community-settings.js

            echo "âœ… Migrations completed"

  # ==================== NOTIFY ====================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.setup.outputs.should-deploy == 'true'

    steps:
      - name: ðŸ“¢ Prepare notification message
        id: message
        env:
          DEPLOY_STATUS: ${{ needs.deploy.result }}
          COMMUNITY: ${{ needs.setup.outputs.community }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          AUTHOR: ${{ github.event.head_commit.author.name }}
        run: |
          if [ "$DEPLOY_STATUS" == "success" ]; then
            MESSAGE="âœ… Deployment to **$COMMUNITY** succeeded!

            **Commit:** $COMMIT_MESSAGE
            **Author:** $AUTHOR
            **Branch:** ${{ github.ref_name }}"
          else
            MESSAGE="âŒ Deployment to **$COMMUNITY** failed!

            **Commit:** $COMMIT_MESSAGE
            **Author:** $AUTHOR
            **Branch:** ${{ github.ref_name }}

            Check workflow logs for details."
          fi

          # Ð•ÐºÑ€Ð°Ð½ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ GitHub Actions
          MESSAGE="${MESSAGE//'%'/'%25'}"
          MESSAGE="${MESSAGE//$'\n'/'%0A'}"
          MESSAGE="${MESSAGE//$'\r'/'%0D'}"

          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: ðŸ“¢ Notify via Telegram (optional)
        if: secrets.TELEGRAM_BOT_TOKEN != ''
        run: |
          # ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´ Ð½Ð¾Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ†Ñ–Ñ— Ð² Telegram
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${{ steps.message.outputs.message }}" \
            -d "parse_mode=Markdown"
        continue-on-error: true

      - name: ðŸ“¢ Notify via Slack (optional)
        if: secrets[format('{0}_SLACK_WEBHOOK', needs.setup.outputs.community-upper)] != ''
        env:
          SLACK_WEBHOOK: ${{ secrets[format('{0}_SLACK_WEBHOOK', needs.setup.outputs.community-upper)] }}
        run: |
          # Community-specific Slack channel
          curl -X POST "$SLACK_WEBHOOK" \
            -H 'Content-Type: application/json' \
            -d "{\"text\": \"${{ steps.message.outputs.message }}\"}"
        continue-on-error: true
